@model MunicipalServicesMvc.Models.IssueCreateViewModel
@{
    ViewBag.Title = "Report Issues";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var categories = (string[])ViewBag.Categories;
}

<div class="menu-card">
    <h2>Report Issues</h2>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    @using (Html.BeginForm("Create", "Issues", FormMethod.Post, new { enctype = "multipart/form-data", id = "issueForm" }))
    {
        @Html.AntiForgeryToken()

        <div class="form-group">
            @Html.LabelFor(m => m.Location)
            @Html.TextBoxFor(m => m.Location, new { @class = "form-control", placeholder = "e.g., 123 Smith Street, Ward 10" })
            @Html.ValidationMessageFor(m => m.Location, "", new { @class = "text-danger" })
        </div>

        <div class="form-group">
            @Html.LabelFor(m => m.Category)
            @Html.DropDownListFor(m => m.Category,
            new SelectList(categories),
                "-- Select a category --",
                new { @class = "form-control" })
        @Html.ValidationMessageFor(m => m.Category, "", new { @class = "text-danger" })
    </div>

    <div class="form-group">
        @Html.LabelFor(m => m.Description)
        @Html.TextAreaFor(m => m.Description, 6, 50, new { @class = "form-control", placeholder = "Describe the issue…" })
        @Html.ValidationMessageFor(m => m.Description, "", new { @class = "text-danger" })
    </div>

    <div class="form-group">
        @Html.LabelFor(m => m.Attachments)
        <input type="file" name="Attachments" id="Attachments" class="form-control" multiple />
        <small class="text-muted">Attach images or documents (JPG, PNG, PDF, DOCX, XLSX). Optional.</small>
    </div>

    <button type="submit" id="btnSubmit" class="btn btn-primary">Submit</button>
    <a href="@Url.Action("Index", "Home")" class="btn btn-default">Back to Main Menu</a>

    <!-- Engagement Progress Bar (client-side) -->
    <div id="submitProgress" class="progress" style="display:none;">
        <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0"
             aria-valuemin="0" aria-valuemax="100"></div>
    </div>
        }

</div>

@section scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        // Show a simple progress bar while the form is submitting.
        (function () {
            var form = document.getElementById('issueForm');
            var btn  = document.getElementById('btnSubmit');
            var barC = document.getElementById('submitProgress');
            var bar  = barC.querySelector('.progress-bar');
            var intervalId;

            function startProgress() {
                barC.style.display = 'block';
                bar.style.width = '0%';
                bar.setAttribute('aria-valuenow', '0');
                var value = 0;
                intervalId = setInterval(function () {
                    // Increment slowly while waiting for server
                    value = Math.min(95, value + 3);
                    bar.style.width = value + '%';
                    bar.setAttribute('aria-valuenow', value);
                }, 120);
            }
            function stopProgress() {
                if (intervalId) clearInterval(intervalId);
                bar.style.width = '100%';
                bar.setAttribute('aria-valuenow', '100');
                setTimeout(function(){
                    barC.style.display = 'none';
                    bar.style.width = '0%';
                    bar.setAttribute('aria-valuenow', '0');
                }, 400);
            }

            form.addEventListener('submit', function (e) {
                if (!$(form).valid()) { return; }
                btn.disabled = true;
                startProgress();
            });

            // If navigating away or after load with TempData success, stop progress
            window.addEventListener('pageshow', function() { stopProgress(); btn.disabled = false; });
        })();
    </script>
}
